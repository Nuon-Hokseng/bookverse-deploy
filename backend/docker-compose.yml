services:
  eureka:
    image: jhipster/jhipster-registry:latest
    container_name: eureka
    environment:
      - SPRING_SECURITY_USER_NAME=admin
      - SPRING_SECURITY_USER_PASSWORD=admin
    ports:
      - "8761:8761"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/management/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - backend

  auth-service:
    container_name: auth-service
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    env_file:
      - ./auth-service/.env
    environment:
      - SERVICE_NAME=auth-service
      - EUREKA_HOST=eureka
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASS=admin
    depends_on:
      eureka:
        condition: service_healthy
    networks:
      - backend

  book-service:
    container_name: book-service
    build:
      context: ./book-service
      dockerfile: Dockerfile
    env_file:
      - ./book-service/.env
    environment:
      - SERVICE_NAME=book-service
      - EUREKA_HOST=eureka
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASS=admin
    depends_on:
      eureka:
        condition: service_healthy
    networks:
      - backend

  cart-service:
    container_name: cart-service
    build:
      context: ./cart-service
      dockerfile: Dockerfile
    env_file:
      - ./cart-service/.env
    environment:
      - SERVICE_NAME=cart-service
      - BOOK_SERVICE_URL=http://book-service:3004/api/books
      - EUREKA_HOST=eureka
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASS=admin
    depends_on:
      book-service:
        condition: service_started
      eureka:
        condition: service_healthy
    networks:
      - backend

  order-service:
    container_name: order-service
    build:
      context: ./order-service
      dockerfile: Dockerfile
    env_file:
      - ./order-service/.env
    environment:
      - SERVICE_NAME=order-service
      - CART_SERVICE_URL=http://cart-service:3001/api
      - EUREKA_HOST=eureka
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASS=admin
    depends_on:
      cart-service:
        condition: service_started
      eureka:
        condition: service_healthy
    networks:
      - backend

  api-gateway:
    container_name: api-gateway
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    env_file:
      - ./api-gateway/.env
    environment:
      - SERVICE_NAME=api-gateway
      - EUREKA_HOST=eureka
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASS=admin
    ports:
      - "3000:3000"
    depends_on:
      auth-service:
        condition: service_started
      book-service:
        condition: service_started
      cart-service:
        condition: service_started
      order-service:
        condition: service_started
      eureka:
        condition: service_healthy
    networks:
      - backend

networks:
  backend:
    driver: bridge
